/**
*
* HAAR.js Feature Detection Library based on Viola-Jones / Lienhart et al. Haar Detection algorithm
* modified port of jViolaJones for Java (http://code.google.com/p/jviolajones/) and OpenCV for C++ (https://github.com/opencv/opencv) to JavaScript
*
* https://github.com/foo123/HAAR.js
* @version: 1.0.2
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,e,n){"use strict";"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[e]=n.call(t)):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(e)?define(e,["module"],function(e){return n.moduleUri=e.uri,n.call(t)}):e in t||(t[e]=n.call(t)||1)&&"function"==typeof define&&define.amd&&define(function(){return t[e]})}("undefined"!=typeof self?self:this,"HAAR",function(){"use strict";var e,A,t={VERSION:"1.0.2"},n="prototype",_=void 0,v="undefined"!=typeof Float32Array?Float32Array:Array,x="undefined"!=typeof Uint8Array?Uint8Array:Array,m=Math.abs,P=(Math.max,Math.min),o=(Math.floor,Math.round),i=(Math.sqrt,Array[n].slice);function r(e,t,n){for(var i,l,a,r,o,h,s=e.length,c=new Array(s),u=[],d=0,g=!1,f=0;f<s;f++)c[f]=0;for(f=0;f<s;f++){for(g=!1,a=0;a<f;a++)e[a].equals(e[f],n)&&(g=!0,c[f]=c[a]);g||(c[f]=d,d++)}for(i=new Array(d),l=new Array(d),f=0;f<d;f++)i[f]=0,l[f]=new A;for(f=0;f<s;f++)i[h=c[f]]++,l[h].add(e[f]);for(f=0;f<d;f++)t<=(r=i[f])&&(h=new A((o=1/(r+r))*(2*l[f].x+r),o*(2*l[f].y+r),o*(2*l[f].width+r),o*(2*l[f].height+r)),u.push(h));for(s=u.length,f=0;f<s;f++)for(a=f+1;a<s;a++)!u[f].isInside&&u[f].inside(u[a])?u[f].isInside=!0:!u[a].isInside&&u[a].inside(u[f])&&(u[a].isInside=!0);for(f=s;0<=--f;)u[f].isInside&&u.splice(f,1);return u}function h(e,t){return t.area-e.area}function T(e,t){return e.index-t.index}function j(e){return e[1].length&&(e[0]=e[0].concat(e[1]).sort(T)),e[0]}function D(e){for(var t,n,i,l,a,r,o,h,s,c,u,d,g,f,y,w,v,x,m,p,S,I,C,b,q,R,H,A,_,P,T,j,D=D||Math.sqrt,L=[],M=e.haardata,W=M.stages,z=e.scaledSelection,k=e.width,E=e.height,F=z.width,U=z.height,$=k*E,O=$-1,V=M.size1,E=M.size2,N=z.x,M=z.y,B=W.length,G=e.cannyLow,J=e.cannyHigh,K=e.canny,Q=e.integral,X=e.squares,Y=e.tilted,Z=e.scale,z=e.increment,ee=e.i||0,te=e.doCannyPruning,ne=k-1,ie=$-k,le=~~(Z*V),ae=~~(le*z),re=~~(Z*E),oe=~~(re*z),he=re*k,se=oe*k,ce=F-le,ue=U-re,de=1/(le*re),ge=M,fe=M*se;ge<ue;ge+=oe,fe+=se)for(t=N;t<ce;t+=ae)if(i=(n=t-1+fe-k)+le,a=(l=n+he)+le,n=n<0?0:O<n?O:n,i=i<0?0:O<i?O:i,l=l<0?0:O<l?O:l,a=a<0?0:O<a?O:a,!te||!((h=de*(K[a]-K[l]-K[i]+K[n]))<G||J<h)){for(h=de*(Q[a]-Q[l]-Q[i]+Q[n]),o=1<(o=de*(X[a]-X[l]-X[i]+X[n])-h*h)?D(o):1,s=!0,r=0;r<B;r++){for(u=(c=W[r]).thres,g=(d=c.trees).length,f=j=0;f<g;f++)for(w=d[f].feats,y=0;;){if(m=(x=(v=w[y]).rects).length,p=v.thres,S=0,v.tilt)for(I=0;I<m;I++)b=t+~~(Z*(C=x[I])[0]),q=(ge-1+~~(Z*C[1]))*k,R=t+~~(Z*(C[0]+C[2])),H=(ge-1+~~(Z*(C[1]+C[2])))*k,A=t+~~(Z*(C[0]-C[3])),_=(ge-1+~~(Z*(C[1]+C[3])))*k,b=b<0?0:ne<b?ne:b,R=R<0?0:ne<R?ne:R,A=A<0?0:ne<A?ne:A,P=(P=t+~~(Z*(C[0]+C[2]-C[3])))<0?0:ne<P?ne:P,q=q<0?0:ie<q?ie:q,H=H<0?0:ie<H?ie:H,_=_<0?0:ie<_?ie:_,T=(T=(ge-1+~~(Z*(C[1]+C[2]+C[3])))*k)<0?0:ie<T?ie:T,S+=C[4]*(Y[P+T]-Y[A+_]-Y[R+H]+Y[b+q]);else for(I=0;I<m;I++)b=(b=t-1+~~(Z*(C=x[I])[0]))<0?0:ne<b?ne:b,R=(R=t-1+~~(Z*(C[0]+C[2])))<0?0:ne<R?ne:R,q=(q=k*(ge-1+~~(Z*C[1])))<0?0:ie<q?ie:q,H=(H=k*(ge-1+~~(Z*(C[1]+C[3]))))<0?0:ie<H?ie:H,S+=C[4]*(Q[R+H]-Q[b+H]-Q[R+q]+Q[b+q]);if(S*de<p*o?0:1){if(v.has_r){j+=v.r_val;break}y=v.r_node}else{if(v.has_l){j+=v.l_val;break}y=v.l_node}}if(!(s=u<j))break}s&&L.push({index:ee,x:t,y:ge,width:le,height:re})}return L}function L(e,t,n){for(var i,l=0,a=t.length;l<a;l++)t[l]=new A(t[l]);for(e.objects=r(t,e.min_neighbors,e.epsilon),i=1/e.Ratio,l=0,a=e.objects.length;l<a;l++)e.objects[l].scale(i).round().computeArea();e.objects.sort(h),e.Ready=!0,n&&e.onComplete&&e.onComplete.call(e)}return(e=t.Detector=function(e,t){var n=this;n.haardata=e||null,n.Ready=!1,n.doCannyPruning=!1,n.Canvas=null,n.Selection=null,n.scaledSelection=null,n.objects=null,n.TimeInterval=null,n.DetectInterval=30,n.Ratio=.5,n.cannyLow=20,n.cannyHigh=100,n.Parallel=t||null,n.onComplete=null})[n]={constructor:e,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var e=this;return e.DetectInterval&&clearTimeout(e.DetectInterval),e.DetectInterval=null,e.TimeInterval=null,e.haardata=null,e.Canvas=null,e.objects=null,e.Selection=null,e.scaledSelection=null,e.Ratio=null,e.origWidth=null,e.origHeight=null,e.width=null,e.height=null,e.doCannyPruning=null,e.cannyLow=null,e.cannyHigh=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Parallel=null,e.Ready=null,e.onComplete=null,e},clearCache:function(){var e=this;return e.haardata=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Selection=null,e.scaledSelection=null,e},cascade:function(e){return this.haardata=e||null,this},parallel:function(e){return this.Parallel=e||null,this},image:function(e,t,n){var i,l,a,r=this;return e&&(a=e instanceof HTMLVideoElement,r.Canvas||(r.Canvas=n||document.createElement("canvas")),l=r.Canvas,i=r.Ratio=_===t?1:t,r.Ready=!1,n=r.origWidth=a?e.videoWidth:e.width,t=r.origHeight=a?e.videoHeight:e.height,a=r.width=l.width=o(i*n),i=r.height=l.height=o(i*t),(l=l.getContext("2d")).drawImage(e,0,0,n,t,0,0,a,i),l=function(e,t,n){for(var i,l,a,r,o=e.length,h=new x(n=t*n),s=new v(n),c=new v(n),u=new v(n),d=0,g=0,f=i=0;d<t;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,h[d]=r,s[d]=f,c[d]=i,u[d]=r,d++,g+=4;for(a=1,g=(d=t)<<2,f=i=l=0;g<o;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,h[d]=r,s[d]=s[d-t]+f,c[d]=c[d-t]+i,u[d]=u[d+1-t]+(r+h[d-t])+(1<a?u[d-t-t]:0)+(0<l?u[d-1-t]:0),d++,g+=4,t<=++l&&(a++,f=i=l=0);return{gray:h,integral:s,squares:c,tilted:u}}((l=l.getImageData(0,0,a,i)).data,l.width,l.height),r.integral=l.integral,r.squares=l.squares,r.tilted=l.tilted,r.canny=function(e,t,n){for(var i,l,a,r,o,h,s,c,u,d,g=e.length,f=new x(g),y=new v(g),w=0;w<t;w++)f[w]=0,f[w+t]=0,f[w+g-t]=0,f[w+g-t-t]=0,y[w]=0,y[w+g-t]=0;for(l=i=0;i<n;i++,l+=t)f[0+l]=0,f[1+l]=0,f[t-1+l]=0,y[(f[t-2+l]=0)+l]=0,y[t-1+l]=0;for(w=2;w<t-2;w++)for(a=0,i=2,l=t<<1;i<n-2;i++,l+=t)c=(s=(h=w+l)+t)+t,a=(e[(d=(u=h-t)-t)-2]<<1)+(e[u-2]<<2)+(e[h-2]<<2)+e[h-2]+(e[s-2]<<2)+(e[c-2]<<1)+(e[d-1]<<2)+(e[u-1]<<3)+e[u-1]+(e[h-1]<<4)-(e[h-1]<<2)+(e[s-1]<<3)+e[s-1]+(e[c-1]<<2)+(e[d]<<2)+e[d]+(e[u]<<4)-(e[u]<<2)+(e[h]<<4)-e[h]+(e[s]<<4)-(e[s]<<2)+(e[c]<<2)+e[c]+(e[1+d]<<2)+(e[u+1]<<3)+e[u+1]+(e[h+1]<<4)-(e[h+1]<<2)+(e[s+1]<<3)+e[s+1]+(e[c+1]<<2)+(e[2+d]<<1)+(e[u+2]<<2)+(e[h+2]<<2)+e[h+2]+(e[s+2]<<2)+(e[c+2]<<1),f[h]=((103*a+8192&4294967295)>>>14&255)>>>0;for(w=1;w<t-1;w++)for(i=1,l=t;i<n-1;i++,l+=t)s=(h=l+w)+t,r=0-f[(u=h-t)-1]+f[u+1]-f[h-1]-f[h-1]+f[h+1]+f[h+1]-f[s-1]+f[s+1],o=0+f[u-1]+f[u]+f[u]+f[u+1]-f[s-1]-f[s]-f[s]-f[s+1],y[h]=m(r)+m(o);for(a=w=0;w<t;)a+=y[w],y[w]=a,w++;for(w=t,a=l=0;w<g;)a+=y[w],y[w]=y[w-t]+a,w++,t<=++l&&(a=l=0);return y}(l.gray,a,i),l.gray=null,l.integral=null,l.squares=null,l.tilted=null,l=null),r},interval:function(e){return 0<e&&(this.DetectInterval=e),this},cannyThreshold:function(e){return e&&_!==e.low&&(this.cannyLow=e.low),e&&_!==e.high&&(this.cannyHigh=e.high),this},select:function(){var e=i.call(arguments),t=e.length;return 1==t&&"auto"==e[0]||!t?this.Selection=null:this.Selection=A[n].data.apply(new A,e),this},complete:function(e){return this.onComplete=e||null,this},detect:function(e,t,n,i,l,a){var r,o,h,s=this,c=s.haardata,u=c.size1,d=c.size2,g=s.width,f=s.height,y=s.origWidth,w=s.origHeight,v=s.integral,x=s.squares,m=s.tilted,p=s.canny,S=s.cannyLow,I=s.cannyHigh;s.Selection||(s.Selection=new A(0,0,y,w)),(r=s.Selection).x="auto"==r.x?0:r.x,r.y="auto"==r.y?0:r.y,r.width="auto"==r.width?y:r.width,r.height="auto"==r.height?w:r.height,o=s.scaledSelection=r.clone().scale(s.Ratio).round(),e=_===e?1:e,t=_===t?1.25:t,n=_===n?.5:n,i=_===i?1:i,l=void 0===l?.2:l,a=void 0!==a&&a,h=s.maxScale=P(o.width/u,o.height/d),s.scale=e,s.min_neighbors=i,s.scale_inc=t,s.increment=n,s.epsilon=l,s.doCannyPruning=a,s.Ready=!1;d=s.Parallel;if(d&&d.isSupported()){for(var C=[],b=0,q=e;q<=h;q*=t)C.push({haardata:c,width:g,height:f,scaledSelection:{x:o.x,y:o.y,width:o.width,height:o.height},integral:v,squares:x,tilted:m,doCannyPruning:a,canny:a?p:null,cannyLow:S,cannyHigh:I,maxScale:h,min_neighbors:i,epsilon:l,scale_inc:t,increment:n,scale:q,i:b++});new d(C,{synchronous:!1}).require(T,D,j).map(D).reduce(j).then(function(e){L(s,e,!0)})}else{var R=[],H=function(){s.scale<=s.maxScale?(R=R.concat(D(s)),s.scale*=s.scale_inc,s.TimeInterval=setTimeout(H,s.DetectInterval)):(clearTimeout(s.TimeInterval),L(s,R,!0))};s.TimeInterval=setTimeout(H,s.DetectInterval)}return s},detectSync:function(e,t,n,i,l,a){var r,o=this,h=o.haardata.size1,s=o.haardata.size2;o.Selection||(o.Selection=new A(0,0,o.origWidth,o.origHeight)),o.Selection.x="auto"==o.Selection.x?0:o.Selection.x,o.Selection.y="auto"==o.Selection.y?0:o.Selection.y,o.Selection.width="auto"==o.Selection.width?o.origWidth:o.Selection.width,o.Selection.height="auto"==o.Selection.height?o.origHeight:o.Selection.height,o.scaledSelection=o.Selection.clone().scale(o.Ratio).round(),e=void 0===e?1:e,t=void 0===t?1.25:t,n=void 0===n?.5:n,i=void 0===i?1:i,o.epsilon=void 0===l?.2:l,o.doCannyPruning=void 0!==a&&a,r=o.maxScale=P(o.scaledSelection.width/h,o.scaledSelection.height/s),o.scale=e,o.min_neighbors=i,o.scale_inc=t,o.increment=n,o.Ready=!1;for(var c=[];o.scale<=r;)c=c.concat(D(o)),o.scale*=t;return L(o,c,!1),o.objects}},e[n].selection=e[n].select,(A=t.Feature=function(e,t,n,i,l){this.data(e,t,n,i,l)}).groupRectangles=r,A[n]={constructor:A,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(e,t,n,i,l){var a=this;return e&&e instanceof A?a.copy(e):e&&e instanceof Object?(a.x=e.x||0,a.y=e.y||0,a.width=e.width||0,a.height=e.height||0,a.index=e.index||0,a.area=e.area||0,a.isInside=e.isInside||!1):(a.x=e||0,a.y=t||0,a.width=n||0,a.height=i||0,a.index=l||0,a.area=0,a.isInside=!1),a},add:function(e){var t=this;return t.x+=e.x,t.y+=e.y,t.width+=e.width,t.height+=e.height,t},scale:function(e){var t=this;return t.x*=e,t.y*=e,t.width*=e,t.height*=e,t},round:function(){var e=this;return e.x=~~(e.x+.5),e.y=~~(e.y+.5),e.width=~~(e.width+.5),e.height=~~(e.height+.5),e},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(e,t){null==t&&(t=.1),t<0&&(t=0);var n=e.width*t,t=e.height*t;return this.x>=e.x-n&&this.y>=e.y-t&&this.x+this.width<=e.x+e.width+n&&this.y+this.height<=e.y+e.height+t},contains:function(e,t){return e.inside(this,null==t?.1:t)},equals:function(e,t){null==t&&(t=.2),t<0&&(t=0);t=t*(P(this.width,e.width)+P(this.height,e.height))*.5;return m(this.x-e.x)<=t&&m(this.y-e.y)<=t&&m(this.x+this.width-e.x-e.width)<=t&&m(this.y+this.height-e.y-e.height)<=t},clone:function(){var e=this,t=new A;return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside,t},copy:function(e){var t=this;return e&&e instanceof A&&(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside),t},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}},t});