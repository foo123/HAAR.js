/**
*
* HAAR.js Feature Detection Library based on Viola-Jones / Lienhart et al. Haar Detection algorithm
* modified port of jViolaJones for Java (http://code.google.com/p/jviolajones/) and OpenCV for C++ (https://github.com/opencv/opencv) to JavaScript
*
* https://github.com/foo123/HAAR.js
* @version: 1.0.4
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,e,n){"use strict";"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[e]=n.call(t)):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(e)?define(e,["module"],function(e){return n.moduleUri=e.uri,n.call(t)}):e in t||(t[e]=n.call(t)||1)&&"function"==typeof define&&define.amd&&define(function(){return t[e]})}("undefined"!=typeof self?self:this,"HAAR",function(){"use strict";var e,R,t={VERSION:"1.0.4"},n="prototype",i=void 0,p="undefined"!=typeof Float32Array?Float32Array:Array,v="undefined"!=typeof Uint8Array?Uint8Array:Array,ye=Math,m=ye.abs,S=ye.max,A=ye.min,h=(ye.floor,ye.round),l=(ye.sqrt,Array[n].slice);function o(e,t,n){for(var i,l,a,r,h,o,s=e.length,u=new Array(s),c=[],d=0,g=!1,f=0;f<s;++f)u[f]=0;for(f=0;f<s;++f){for(g=!1,a=0;a<f;++a)e[a].equals(e[f],n)&&(g=!0,u[f]=u[a]);g||(u[f]=d,++d)}for(i=new Array(d),l=new Array(d),f=0;f<d;++f)i[f]=0,l[f]=new R;for(f=0;f<s;++f)++i[o=u[f]],l[o].add(e[f]);for(f=0;f<d;++f)t<=(r=i[f])&&(o=new R((h=1/(r+r))*(2*l[f].x+r),h*(2*l[f].y+r),h*(2*l[f].width+r),h*(2*l[f].height+r)),c.push(o));for(s=c.length,f=0;f<s;++f)for(a=f+1;a<s;++a)!c[f].isInside&&c[f].inside(c[a],n)&&(c[f].isInside=!0),!c[a].isInside&&c[a].inside(c[f],n)&&(c[a].isInside=!0);for(f=s;0<=--f;)c[f].isInside&&c.splice(f,1);return c}function s(e,t){return t.area-e.area}function _(e,t){return e.index-t.index}function T(e){return e[1].length&&(e[0].push.apply(e[0],e[1]),e[0].sort(_)),e[0]}function j(e){for(var t,n,i,l,a,r,h,o,z,E,k,F,M,s,u,U,c,V,$,O,d,g,f,y,w,x,p,v,m,S,I,C,N=ye.sqrt,B=[],b=e.haardata,G=b.stages,q=e.scaledSelection,H=e.width,J=e.height,K=q.width,Q=q.height,J=H*J,R=J-1,X=b.size1,b=b.size2,Y=q.x,q=q.y,Z=G.length,ee=e.cannyLow,te=e.cannyHigh,A=e.canny,_=e.integral,ne=e.squares,ie=e.tilted,T=e.scale,le=e.increment,ae=e.i||0,re=e.doCannyPruning,j=H-1,P=J-H,D=~~(T*X),he=~~(D*le),L=~~(T*b),oe=~~(L*le),se=L*H,ue=oe*H,ce=K-D,de=Q-L,ge=1/(D*L),W=q,fe=q*ue;W<de;W+=oe,fe+=ue)for(t=Y;t<ce;t+=he)if(i=(n=t-1+fe-H)+D,a=(l=n+se)+D,n=n<0?0:R<n?R:n,i=i<0?0:R<i?R:i,l=l<0?0:R<l?R:l,a=a<0?0:R<a?R:a,!re||!((o=ge*(A[a]-A[l]-A[i]+A[n]))<ee||te<o)){for(o=ge*(_[a]-_[l]-_[i]+_[n]),h=1<(h=ge*(ne[a]-ne[l]-ne[i]+ne[n])-o*o)?N(h):1,z=!0,r=0;r<Z;++r){for(k=(E=G[r]).thres,M=(F=E.trees).length,s=C=0;s<M;++s)for(U=F[s].feats,u=0;;){if($=(V=(c=U[u]).rects).length,O=c.thres,d=0,c.tilt)for(g=0;g<$;g++)y=t+~~(T*(f=V[g])[0]),w=(W-1+~~(T*f[1]))*H,x=t+~~(T*(f[0]+f[2])),p=(W-1+~~(T*(f[1]+f[2])))*H,v=t+~~(T*(f[0]-f[3])),m=(W-1+~~(T*(f[1]+f[3])))*H,S=t+~~(T*(f[0]+f[2]-f[3])),I=(W-1+~~(T*(f[1]+f[2]+f[3])))*H,d+=f[4]*(ie[(S<0?0:j<S?j:S)+(I<0?0:P<I?P:I)]-ie[(v<0?0:j<v?j:v)+(m<0?0:P<m?P:m)]-ie[(x=x<0?0:j<x?j:x)+(p=p<0?0:P<p?P:p)]+ie[(y=y<0?0:j<y?j:y)+(w=w<0?0:P<w?P:w)]);else for(g=0;g<$;++g)y=t-1+~~(T*(f=V[g])[0]),x=t-1+~~(T*(f[0]+f[2])),w=H*(W-1+~~(T*f[1])),p=H*(W-1+~~(T*(f[1]+f[3]))),d+=f[4]*(_[(x=x<0?0:j<x?j:x)+(p=p<0?0:P<p?P:p)]-_[(y=y<0?0:j<y?j:y)+p]-_[x+(w=w<0?0:P<w?P:w)]+_[y+w]);if(d*ge<O*h?0:1){if(c.has_r){C+=c.r_val;break}u=c.r_node}else{if(c.has_l){C+=c.l_val;break}u=c.l_node}}if(!(z=k<C))break}z&&B.push({index:ae,x:t,y:W,width:D,height:L})}return B}function P(e,t,n){for(var i,l,a=0,r=t.length;a<r;++a)t[a]=new R(t[a]);for(e.objects=o(t,e.min_neighbors,e.epsilon),l=1/e.Ratio,a=0,r=e.objects.length;a<r;++a)(i=e.objects[a]).scale(l).round().computeArea(),e.objects[a]={x:i.x,y:i.y,width:i.width,height:i.height,area:i.area};e.objects.sort(s),e.Ready=!0,n&&e.onComplete&&e.onComplete.call(e)}return((e=t.Detector=function(e,t){var n=this;n.haardata=e||null,n.Ready=!1,n.doCannyPruning=!1,n.Canvas=null,n.Selection=null,n.scaledSelection=null,n.objects=null,n.TimeInterval=null,n.DetectInterval=30,n.Ratio=.5,n.cannyLow=20,n.cannyHigh=100,n.Parallel=t||null,n.onComplete=null})[n]={constructor:e,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var e=this;return e.DetectInterval&&clearTimeout(e.DetectInterval),e.DetectInterval=null,e.TimeInterval=null,e.haardata=null,e.Canvas=null,e.objects=null,e.Selection=null,e.scaledSelection=null,e.Ratio=null,e.origWidth=null,e.origHeight=null,e.width=null,e.height=null,e.doCannyPruning=null,e.cannyLow=null,e.cannyHigh=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Parallel=null,e.Ready=null,e.onComplete=null,e},clearCache:function(){var e=this;return e.haardata=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Selection=null,e.scaledSelection=null,e},cascade:function(e){return this.haardata=e||null,this},parallel:function(e){return this.Parallel=e||null,this},image:function(e,t,n){var i,l,a,r=this;return e&&(a="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement,r.Canvas||(r.Canvas=n||document.createElement("canvas")),n=r.Canvas,t=r.Ratio=null==t?1:+t,r.Ready=!1,i=r.origWidth=a?e.videoWidth:e.width,a=r.origHeight=a?e.videoHeight:e.height,l=r.width=n.width=h(t*i),t=r.height=n.height=h(t*a),(n=n.getContext("2d")).drawImage(e,0,0,i,a,0,0,l,t),i=function(e,t,n){for(var i,l,a,r,h=e.length,o=new v(n=t*n),s=new p(n),u=new p(n),c=new p(n),d=0,g=0,f=i=0;d<t;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,o[d]=r,s[d]=f,u[d]=i,c[d]=r,++d,g+=4;for(a=1,g=(d=t)<<2,f=i=l=0;g<h;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,o[d]=r,s[d]=s[d-t]+f,u[d]=u[d-t]+i,c[d]=c[d+1-t]+(r+o[d-t])+(1<a?c[d-t-t]:0)+(0<l?c[d-1-t]:0),++d,g+=4,t<=++l&&(++a,f=i=l=0);return{gray:o,integral:s,squares:u,tilted:c}}((e=n.getImageData(0,0,l,t)).data,e.width,e.height),r.integral=i.integral,r.squares=i.squares,r.tilted=i.tilted,r.canny=function(e,t,n){for(var i,l,a,r,h,o,s,u,c,d,g,f=e.length,y=new v(f),w=new p(f),x=0;x<t;++x)y[x]=0,y[x+t]=0,y[x+f-t]=0,y[x+f-t-t]=0,w[x]=0,w[x+f-t]=0;for(l=i=0;i<n;++i,l+=t)y[0+l]=0,y[1+l]=0,y[t-1+l]=0,w[(y[t-2+l]=0)+l]=0,w[t-1+l]=0;for(x=2;x+2<t;++x)for(a=0,i=2,l=t<<1;i+2<n;++i,l+=t)a=(e[(g=(d=(s=x+l)-t)-t)-2]<<1)+(e[d-2]<<2)+(e[s-2]<<2)+e[s-2]+(e[(u=s+t)-2]<<2)+(e[(c=u+t)-2]<<1)+(e[g-1]<<2)+(e[d-1]<<3)+e[d-1]+(e[s-1]<<4)-(e[s-1]<<2)+(e[u-1]<<3)+e[u-1]+(e[c-1]<<2)+(e[g]<<2)+e[g]+(e[d]<<4)-(e[d]<<2)+(e[s]<<4)-e[s]+(e[u]<<4)-(e[u]<<2)+(e[c]<<2)+e[c]+(e[1+g]<<2)+(e[d+1]<<3)+e[d+1]+(e[s+1]<<4)-(e[s+1]<<2)+(e[u+1]<<3)+e[u+1]+(e[c+1]<<2)+(e[2+g]<<1)+(e[d+2]<<2)+(e[s+2]<<2)+e[s+2]+(e[u+2]<<2)+(e[c+2]<<1),y[s]=((103*a+8192&4294967295)>>>14&255)>>>0;for(x=1;x+1<t;++x)for(i=1,l=t;i+1<n;++i,l+=t)h=0-y[(d=(s=l+x)-t)-1]+y[d+1]-y[s-1]-y[s-1]+y[s+1]+y[s+1]-y[(u=s+t)-1]+y[u+1],r=0+y[d-1]+y[d]+y[d]+y[d+1]-y[u-1]-y[u]-y[u]-y[u+1],h=m(h),r=m(r),o=S(h,r),h=A(h,r),w[s]=o?o*(1+.43*h/o*h/o):0;for(a=x=0;x<t;)a+=w[x],w[x]=a,++x;for(x=t,a=l=0;x<f;)a+=w[x],w[x]=w[x-t]+a,++x,t<=++l&&(a=l=0);return w}(i.gray,l,t),i.gray=null,i.integral=null,i.squares=null,i.tilted=null,i=null),r},interval:function(e){return 0<e&&(this.DetectInterval=e),this},cannyThreshold:function(e){return e&&i!==e.low&&(this.cannyLow=e.low),e&&i!==e.high&&(this.cannyHigh=e.high),this},select:function(){var e=l.call(arguments),t=e.length;return 1==t&&"auto"==e[0]||!t?this.Selection=null:this.Selection=R[n].data.apply(new R,e),this},complete:function(e){return this.onComplete=e||null,this},detect:function(e,t,n,i,l,a){var r,h,o,s=this,u=s.haardata,c=u.size1,d=u.size2,g=s.width,f=s.height,y=s.origWidth,w=s.origHeight,x=s.integral,p=s.squares,v=s.tilted,m=s.canny,S=s.cannyLow,I=s.cannyHigh,y=(s.Selection||(s.Selection=new R(0,0,y,w)),(r=s.Selection).x="auto"==r.x?0:r.x,r.y="auto"==r.y?0:r.y,r.width="auto"==r.width?y:r.width,r.height="auto"==r.height?w:r.height,h=s.scaledSelection=r.clone().scale(s.Ratio).round(),e=null==e?1:+e,t=null==t?1.25:+t,n=null==n?.5:+n,i=null==i?1:+i,l=void 0===l?.2:+l,a=void 0!==a&&!!a,o=s.maxScale=A(h.width/c,h.height/d),s.scale=e,s.min_neighbors=i,s.scale_inc=t,s.increment=n,s.epsilon=l,s.doCannyPruning=a,s.Ready=!1,s.Parallel);if(y&&y.isSupported()){for(var C=[],b=0,q=e;q<=o;q*=t)C.push({haardata:u,width:g,height:f,scaledSelection:{x:h.x,y:h.y,width:h.width,height:h.height},integral:x,squares:p,tilted:v,doCannyPruning:a,canny:a?m:null,cannyLow:S,cannyHigh:I,maxScale:o,min_neighbors:i,epsilon:l,scale_inc:t,increment:n,scale:q,i:b++});new y(C,{synchronous:!1}).require(_,j,T).map(j).reduce(T).then(function(e){P(s,e,!0)})}else{var H=[];s.TimeInterval=setTimeout(function e(){s.scale<=s.maxScale?(H.push.apply(H,j(s)),s.scale*=s.scale_inc,s.TimeInterval=setTimeout(e,s.DetectInterval)):(clearTimeout(s.TimeInterval),P(s,H,!0))},s.DetectInterval)}return s},detectSync:function(e,t,n,i,l,a){for(var r,h=this,o=h.haardata.size1,s=h.haardata.size2,u=(h.Selection||(h.Selection=new R(0,0,h.origWidth,h.origHeight)),h.Selection.x="auto"==h.Selection.x?0:h.Selection.x,h.Selection.y="auto"==h.Selection.y?0:h.Selection.y,h.Selection.width="auto"==h.Selection.width?h.origWidth:h.Selection.width,h.Selection.height="auto"==h.Selection.height?h.origHeight:h.Selection.height,h.scaledSelection=h.Selection.clone().scale(h.Ratio).round(),e=null==e?1:+e,t=null==t?1.25:+t,n=null==n?.5:+n,i=null==i?1:+i,h.epsilon=void 0===l?.2:+l,h.doCannyPruning=void 0!==a&&!!a,r=h.maxScale=A(h.scaledSelection.width/o,h.scaledSelection.height/s),h.scale=e,h.min_neighbors=i,h.scale_inc=t,h.increment=n,h.Ready=!1,[]);h.scale<=r;)u.push.apply(u,j(h)),h.scale*=t;return P(h,u,!1),h.objects}}).selection=e[n].select,(R=t.Feature=function(e,t,n,i,l){this.data(e,t,n,i,l)}).groupRectangles=o,R[n]={constructor:R,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(e,t,n,i,l){var a=this;return e&&e instanceof R?a.copy(e):e&&e instanceof Object?(a.x=e.x||0,a.y=e.y||0,a.width=e.width||0,a.height=e.height||0,a.index=e.index||0,a.area=e.area||0,a.isInside=e.isInside||!1):(a.x=e||0,a.y=t||0,a.width=n||0,a.height=i||0,a.index=l||0,a.area=0,a.isInside=!1),a},add:function(e){var t=this;return t.x+=e.x,t.y+=e.y,t.width+=e.width,t.height+=e.height,t},scale:function(e){var t=this;return t.x*=e,t.y*=e,t.width*=e,t.height*=e,t},round:function(){var e=this;return e.x=~~(e.x+.5),e.y=~~(e.y+.5),e.width=~~(e.width+.5),e.height=~~(e.height+.5),e},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(e,t){var n=e.width*(t=(t=null==t?.1:t)<0?0:t),t=e.height*t;return this.x>=e.x-n&&this.y>=e.y-t&&this.x+this.width<=e.x+e.width+n&&this.y+this.height<=e.y+e.height+t},contains:function(e,t){return e.inside(this,null==t?.1:t)},equals:function(e,t){t=(t=(t=null==t?.2:t)<0?0:t)*(A(this.width,e.width)+A(this.height,e.height))*.5;return m(this.x-e.x)<=t&&m(this.y-e.y)<=t&&m(this.x+this.width-e.x-e.width)<=t&&m(this.y+this.height-e.y-e.height)<=t},clone:function(){var e=this,t=new R;return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside,t},copy:function(e){var t=this;return e&&e instanceof R&&(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside),t},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}},t});