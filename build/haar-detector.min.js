/**
*
* HAAR.js Feature Detection Library based on Viola-Jones / Lienhart et al. Haar Detection algorithm
* modified port of jViolaJones for Java (http://code.google.com/p/jviolajones/) and OpenCV for C++ (https://github.com/opencv/opencv) to JavaScript
*
* https://github.com/foo123/HAAR.js
* @version: 1.0.3
*
* Supports parallel "map-reduce" computation both in browser and node using parallel.js library
* https://github.com/adambom/parallel.js (included)
*
**/!function(t,e,n){"use strict";"object"==typeof module&&module.exports?(module.$deps=module.$deps||{})&&(module.exports=module.$deps[e]=n.call(t)):"function"==typeof define&&define.amd&&"function"==typeof require&&"function"==typeof require.specified&&require.specified(e)?define(e,["module"],function(e){return n.moduleUri=e.uri,n.call(t)}):e in t||(t[e]=n.call(t)||1)&&"function"==typeof define&&define.amd&&define(function(){return t[e]})}("undefined"!=typeof self?self:this,"HAAR",function(){"use strict";var e,A,t={VERSION:"1.0.3"},n="prototype",_=void 0,v="undefined"!=typeof Float32Array?Float32Array:Array,x="undefined"!=typeof Uint8Array?Uint8Array:Array,m=Math.abs,T=(Math.max,Math.min),o=(Math.floor,Math.round),i=(Math.sqrt,Array[n].slice);function r(e,t,n){for(var i,l,a,r,o,h,s=e.length,c=new Array(s),u=[],d=0,g=!1,f=0;f<s;f++)c[f]=0;for(f=0;f<s;f++){for(g=!1,a=0;a<f;a++)e[a].equals(e[f],n)&&(g=!0,c[f]=c[a]);g||(c[f]=d,d++)}for(i=new Array(d),l=new Array(d),f=0;f<d;f++)i[f]=0,l[f]=new A;for(f=0;f<s;f++)i[h=c[f]]++,l[h].add(e[f]);for(f=0;f<d;f++)t<=(r=i[f])&&(h=new A((o=1/(r+r))*(2*l[f].x+r),o*(2*l[f].y+r),o*(2*l[f].width+r),o*(2*l[f].height+r)),u.push(h));for(s=u.length,f=0;f<s;f++)for(a=f+1;a<s;a++)!u[f].isInside&&u[f].inside(u[a])?u[f].isInside=!0:!u[a].isInside&&u[a].inside(u[f])&&(u[a].isInside=!0);for(f=s;0<=--f;)u[f].isInside&&u.splice(f,1);return u}function h(e,t){return t.area-e.area}function P(e,t){return e.index-t.index}function j(e){return e[1].length&&(e[0]=e[0].concat(e[1]).sort(P)),e[0]}function D(e){for(var t,n,i,l,a,r,o,h,W,z,E,k,F,s,c,U,u,V,$,O,d,g,f,y,w,v,x,m,p,S,I,C,N=Math.sqrt,B=[],b=e.haardata,G=b.stages,q=e.scaledSelection,H=e.width,J=e.height,K=q.width,Q=q.height,J=H*J,R=J-1,X=b.size1,b=b.size2,Y=q.x,q=q.y,Z=G.length,ee=e.cannyLow,te=e.cannyHigh,A=e.canny,_=e.integral,ne=e.squares,ie=e.tilted,T=e.scale,le=e.increment,ae=e.i||0,re=e.doCannyPruning,P=H-1,j=J-H,D=~~(T*X),oe=~~(D*le),L=~~(T*b),he=~~(L*le),se=L*H,ce=he*H,ue=K-D,de=Q-L,ge=1/(D*L),M=q,fe=q*ce;M<de;M+=he,fe+=ce)for(t=Y;t<ue;t+=oe)if(i=(n=t-1+fe-H)+D,a=(l=n+se)+D,n=n<0?0:R<n?R:n,i=i<0?0:R<i?R:i,l=l<0?0:R<l?R:l,a=a<0?0:R<a?R:a,!re||!((h=ge*(A[a]-A[l]-A[i]+A[n]))<ee||te<h)){for(h=ge*(_[a]-_[l]-_[i]+_[n]),o=1<(o=ge*(ne[a]-ne[l]-ne[i]+ne[n])-h*h)?N(o):1,W=!0,r=0;r<Z;r++){for(E=(z=G[r]).thres,F=(k=z.trees).length,s=C=0;s<F;s++)for(U=k[s].feats,c=0;;){if($=(V=(u=U[c]).rects).length,O=u.thres,d=0,u.tilt)for(g=0;g<$;g++)y=t+~~(T*(f=V[g])[0]),w=(M-1+~~(T*f[1]))*H,v=t+~~(T*(f[0]+f[2])),x=(M-1+~~(T*(f[1]+f[2])))*H,m=t+~~(T*(f[0]-f[3])),p=(M-1+~~(T*(f[1]+f[3])))*H,S=t+~~(T*(f[0]+f[2]-f[3])),I=(M-1+~~(T*(f[1]+f[2]+f[3])))*H,d+=f[4]*(ie[(S<0?0:P<S?P:S)+(I<0?0:j<I?j:I)]-ie[(m<0?0:P<m?P:m)+(p<0?0:j<p?j:p)]-ie[(v=v<0?0:P<v?P:v)+(x=x<0?0:j<x?j:x)]+ie[(y=y<0?0:P<y?P:y)+(w=w<0?0:j<w?j:w)]);else for(g=0;g<$;g++)y=t-1+~~(T*(f=V[g])[0]),v=t-1+~~(T*(f[0]+f[2])),w=H*(M-1+~~(T*f[1])),x=H*(M-1+~~(T*(f[1]+f[3]))),d+=f[4]*(_[(v=v<0?0:P<v?P:v)+(x=x<0?0:j<x?j:x)]-_[(y=y<0?0:P<y?P:y)+x]-_[v+(w=w<0?0:j<w?j:w)]+_[y+w]);if(d*ge<O*o?0:1){if(u.has_r){C+=u.r_val;break}c=u.r_node}else{if(u.has_l){C+=u.l_val;break}c=u.l_node}}if(!(W=E<C))break}W&&B.push({index:ae,x:t,y:M,width:D,height:L})}return B}function L(e,t,n){for(var i,l=0,a=t.length;l<a;l++)t[l]=new A(t[l]);for(e.objects=r(t,e.min_neighbors,e.epsilon),i=1/e.Ratio,l=0,a=e.objects.length;l<a;l++)e.objects[l].scale(i).round().computeArea();e.objects.sort(h),e.Ready=!0,n&&e.onComplete&&e.onComplete.call(e)}return((e=t.Detector=function(e,t){var n=this;n.haardata=e||null,n.Ready=!1,n.doCannyPruning=!1,n.Canvas=null,n.Selection=null,n.scaledSelection=null,n.objects=null,n.TimeInterval=null,n.DetectInterval=30,n.Ratio=.5,n.cannyLow=20,n.cannyHigh=100,n.Parallel=t||null,n.onComplete=null})[n]={constructor:e,haardata:null,Canvas:null,objects:null,Selection:null,scaledSelection:null,Ratio:.5,origWidth:0,origHeight:0,width:0,height:0,DetectInterval:30,TimeInterval:null,doCannyPruning:!1,cannyLow:20,cannyHigh:100,canny:null,integral:null,squares:null,tilted:null,Parallel:null,Ready:!1,onComplete:null,dispose:function(){var e=this;return e.DetectInterval&&clearTimeout(e.DetectInterval),e.DetectInterval=null,e.TimeInterval=null,e.haardata=null,e.Canvas=null,e.objects=null,e.Selection=null,e.scaledSelection=null,e.Ratio=null,e.origWidth=null,e.origHeight=null,e.width=null,e.height=null,e.doCannyPruning=null,e.cannyLow=null,e.cannyHigh=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Parallel=null,e.Ready=null,e.onComplete=null,e},clearCache:function(){var e=this;return e.haardata=null,e.canny=null,e.integral=null,e.squares=null,e.tilted=null,e.Selection=null,e.scaledSelection=null,e},cascade:function(e){return this.haardata=e||null,this},parallel:function(e){return this.Parallel=e||null,this},image:function(e,t,n){var i,l,a,r=this;return e&&(a="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement,r.Canvas||(r.Canvas=n||document.createElement("canvas")),n=r.Canvas,t=r.Ratio=_===t?1:t,r.Ready=!1,i=r.origWidth=a?e.videoWidth:e.width,a=r.origHeight=a?e.videoHeight:e.height,l=r.width=n.width=o(t*i),t=r.height=n.height=o(t*a),(n=n.getContext("2d")).drawImage(e,0,0,i,a,0,0,l,t),i=function(e,t,n){for(var i,l,a,r,o=e.length,h=new x(n=t*n),s=new v(n),c=new v(n),u=new v(n),d=0,g=0,f=i=0;d<t;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,h[d]=r,s[d]=f,c[d]=i,u[d]=r,d++,g+=4;for(a=1,g=(d=t)<<2,f=i=l=0;g<o;)r=4899*e[g]+9617*e[g+1]+1868*e[g+2]+8192>>>14,f+=r&=255,i+=r*r,h[d]=r,s[d]=s[d-t]+f,c[d]=c[d-t]+i,u[d]=u[d+1-t]+(r+h[d-t])+(1<a?u[d-t-t]:0)+(0<l?u[d-1-t]:0),d++,g+=4,t<=++l&&(a++,f=i=l=0);return{gray:h,integral:s,squares:c,tilted:u}}((e=n.getImageData(0,0,l,t)).data,e.width,e.height),r.integral=i.integral,r.squares=i.squares,r.tilted=i.tilted,r.canny=function(e,t,n){for(var i,l,a,r,o,h,s,c,u,d,g=e.length,f=new x(g),y=new v(g),w=0;w<t;w++)f[w]=0,f[w+t]=0,f[w+g-t]=0,f[w+g-t-t]=0,y[w]=0,y[w+g-t]=0;for(l=i=0;i<n;i++,l+=t)f[0+l]=0,f[1+l]=0,f[t-1+l]=0,y[(f[t-2+l]=0)+l]=0,y[t-1+l]=0;for(w=2;w<t-2;w++)for(a=0,i=2,l=t<<1;i<n-2;i++,l+=t)a=(e[(d=(u=(h=w+l)-t)-t)-2]<<1)+(e[u-2]<<2)+(e[h-2]<<2)+e[h-2]+(e[(s=h+t)-2]<<2)+(e[(c=s+t)-2]<<1)+(e[d-1]<<2)+(e[u-1]<<3)+e[u-1]+(e[h-1]<<4)-(e[h-1]<<2)+(e[s-1]<<3)+e[s-1]+(e[c-1]<<2)+(e[d]<<2)+e[d]+(e[u]<<4)-(e[u]<<2)+(e[h]<<4)-e[h]+(e[s]<<4)-(e[s]<<2)+(e[c]<<2)+e[c]+(e[1+d]<<2)+(e[u+1]<<3)+e[u+1]+(e[h+1]<<4)-(e[h+1]<<2)+(e[s+1]<<3)+e[s+1]+(e[c+1]<<2)+(e[2+d]<<1)+(e[u+2]<<2)+(e[h+2]<<2)+e[h+2]+(e[s+2]<<2)+(e[c+2]<<1),f[h]=((103*a+8192&4294967295)>>>14&255)>>>0;for(w=1;w<t-1;w++)for(i=1,l=t;i<n-1;i++,l+=t)r=0-f[(u=(h=l+w)-t)-1]+f[u+1]-f[h-1]-f[h-1]+f[h+1]+f[h+1]-f[(s=h+t)-1]+f[s+1],o=0+f[u-1]+f[u]+f[u]+f[u+1]-f[s-1]-f[s]-f[s]-f[s+1],y[h]=m(r)+m(o);for(a=w=0;w<t;)a+=y[w],y[w]=a,w++;for(w=t,a=l=0;w<g;)a+=y[w],y[w]=y[w-t]+a,w++,t<=++l&&(a=l=0);return y}(i.gray,l,t),i.gray=null,i.integral=null,i.squares=null,i.tilted=null,i=null),r},interval:function(e){return 0<e&&(this.DetectInterval=e),this},cannyThreshold:function(e){return e&&_!==e.low&&(this.cannyLow=e.low),e&&_!==e.high&&(this.cannyHigh=e.high),this},select:function(){var e=i.call(arguments),t=e.length;return 1==t&&"auto"==e[0]||!t?this.Selection=null:this.Selection=A[n].data.apply(new A,e),this},complete:function(e){return this.onComplete=e||null,this},detect:function(e,t,n,i,l,a){var r,o,h,s=this,c=s.haardata,u=c.size1,d=c.size2,g=s.width,f=s.height,y=s.origWidth,w=s.origHeight,v=s.integral,x=s.squares,m=s.tilted,p=s.canny,S=s.cannyLow,I=s.cannyHigh,y=(s.Selection||(s.Selection=new A(0,0,y,w)),(r=s.Selection).x="auto"==r.x?0:r.x,r.y="auto"==r.y?0:r.y,r.width="auto"==r.width?y:r.width,r.height="auto"==r.height?w:r.height,o=s.scaledSelection=r.clone().scale(s.Ratio).round(),e=_===e?1:e,t=_===t?1.25:t,n=_===n?.5:n,i=_===i?1:i,l=void 0===l?.2:l,a=void 0!==a&&a,h=s.maxScale=T(o.width/u,o.height/d),s.scale=e,s.min_neighbors=i,s.scale_inc=t,s.increment=n,s.epsilon=l,s.doCannyPruning=a,s.Ready=!1,s.Parallel);if(y&&y.isSupported()){for(var C=[],b=0,q=e;q<=h;q*=t)C.push({haardata:c,width:g,height:f,scaledSelection:{x:o.x,y:o.y,width:o.width,height:o.height},integral:v,squares:x,tilted:m,doCannyPruning:a,canny:a?p:null,cannyLow:S,cannyHigh:I,maxScale:h,min_neighbors:i,epsilon:l,scale_inc:t,increment:n,scale:q,i:b++});new y(C,{synchronous:!1}).require(P,D,j).map(D).reduce(j).then(function(e){L(s,e,!0)})}else{var H=[],R=function(){s.scale<=s.maxScale?(H=H.concat(D(s)),s.scale*=s.scale_inc,s.TimeInterval=setTimeout(R,s.DetectInterval)):(clearTimeout(s.TimeInterval),L(s,H,!0))};s.TimeInterval=setTimeout(R,s.DetectInterval)}return s},detectSync:function(e,t,n,i,l,a){for(var r,o=this,h=o.haardata.size1,s=o.haardata.size2,c=(o.Selection||(o.Selection=new A(0,0,o.origWidth,o.origHeight)),o.Selection.x="auto"==o.Selection.x?0:o.Selection.x,o.Selection.y="auto"==o.Selection.y?0:o.Selection.y,o.Selection.width="auto"==o.Selection.width?o.origWidth:o.Selection.width,o.Selection.height="auto"==o.Selection.height?o.origHeight:o.Selection.height,o.scaledSelection=o.Selection.clone().scale(o.Ratio).round(),e=void 0===e?1:e,t=void 0===t?1.25:t,n=void 0===n?.5:n,i=void 0===i?1:i,o.epsilon=void 0===l?.2:l,o.doCannyPruning=void 0!==a&&a,r=o.maxScale=T(o.scaledSelection.width/h,o.scaledSelection.height/s),o.scale=e,o.min_neighbors=i,o.scale_inc=t,o.increment=n,o.Ready=!1,[]);o.scale<=r;)c=c.concat(D(o)),o.scale*=t;return L(o,c,!1),o.objects}}).selection=e[n].select,(A=t.Feature=function(e,t,n,i,l){this.data(e,t,n,i,l)}).groupRectangles=r,A[n]={constructor:A,index:0,x:0,y:0,width:0,height:0,area:0,isInside:!1,data:function(e,t,n,i,l){var a=this;return e&&e instanceof A?a.copy(e):e&&e instanceof Object?(a.x=e.x||0,a.y=e.y||0,a.width=e.width||0,a.height=e.height||0,a.index=e.index||0,a.area=e.area||0,a.isInside=e.isInside||!1):(a.x=e||0,a.y=t||0,a.width=n||0,a.height=i||0,a.index=l||0,a.area=0,a.isInside=!1),a},add:function(e){var t=this;return t.x+=e.x,t.y+=e.y,t.width+=e.width,t.height+=e.height,t},scale:function(e){var t=this;return t.x*=e,t.y*=e,t.width*=e,t.height*=e,t},round:function(){var e=this;return e.x=~~(e.x+.5),e.y=~~(e.y+.5),e.width=~~(e.width+.5),e.height=~~(e.height+.5),e},computeArea:function(){return this.area=this.width*this.height,this.area},inside:function(e,t){var n=e.width*(t=(t=null==t?.1:t)<0?0:t),t=e.height*t;return this.x>=e.x-n&&this.y>=e.y-t&&this.x+this.width<=e.x+e.width+n&&this.y+this.height<=e.y+e.height+t},contains:function(e,t){return e.inside(this,null==t?.1:t)},equals:function(e,t){t=(t=(t=null==t?.2:t)<0?0:t)*(T(this.width,e.width)+T(this.height,e.height))*.5;return m(this.x-e.x)<=t&&m(this.y-e.y)<=t&&m(this.x+this.width-e.x-e.width)<=t&&m(this.y+this.height-e.y-e.height)<=t},clone:function(){var e=this,t=new A;return t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside,t},copy:function(e){var t=this;return e&&e instanceof A&&(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,t.index=e.index,t.area=e.area,t.isInside=e.isInside),t},toString:function(){return["[ x:",this.x,"y:",this.y,"width:",this.width,"height:",this.height,"]"].join(" ")}},t});